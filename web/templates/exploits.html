{% extends "base.html" %} {% block head %} {{ super() }}
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.21.0/ace.js"
  integrity="sha512-Fv048ivDjkHY/u2gRxmZCeewXHbP/f17sH3KPpyfkVlmNrbzR3EVVoEzLBoB44o3GRw7CRUobhrv5j0M0VaTFA=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.21.1/mode-python.min.js"
  integrity="sha512-DUdq0nHbbCHQMqQNALNivk5tAdpFWOpm3mplXDwBqIpXD6/vfgXp8fESbfsnePQT3jZKVI3mCbEQumz/S4IHPA=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<!-- socket -->
<script>
  var socket = io(window.location.host, { rememberTransport: false });
  socket.on('connect', function () {
      socket.emit('connected', {});
  });
  var logpath = ''
  filenames = [];
  {% for filename in filenames %}
  logpath = '../logs/exploits/' + '{{ filename }}'.split('.')[0] + '.log'
  filenames.push('{{ filename }}')
  socket.on(logpath, (file) => {
      document.getElementById('{{ filename }}').innerHTML = file;
  });
  {% endfor %}
</script>
<!---->
<script>
  function submitForm() {
    fileslist = document.getElementById("fileinput").files;
    //console.log(fileslist);
    for (let i = 0; i < fileslist.length; i++) {
      if (filenames.includes(fileslist[i].name)) {
        let c = confirm(
          "A file already exists with the same name (" +
            fileslist[i].name +
            ")\nAre you sure you want to overwrite it?"
        );
        if (c == false) {
          return;
        }
      }
    }
    document.fileuploadform.submit();
  }
</script>
<script>
  function dropHandler(ev) {
    ev.preventDefault();

    // Use DataTransfer interface to access the file(s)
    [ev.dataTransfer.files].forEach((file, i) => {
      // Add the file to the form
      document.getElementById("fileinput").files = file;
    });
    submitForm();
  }
</script>
<script>
  function dragOverHandler(ev) {
    ev.preventDefault();
    new_text =
      "flex justify-center w-full h-32 px-4 transition bg-primary rounded-md appearance-none cursor-pointer border-2 border-viola border-dashed";
    document.getElementById("dnd-box").setAttribute("class", new_text);
  }
</script>
<script>
  function dragLeaveHandler(ev) {
    new_text =
      "flex justify-center w-full h-32 px-4 transition bg-primary rounded-md appearance-none cursor-pointer hover:border-2 border-viola border-dashed";
    document.getElementById("dnd-box").setAttribute("class", new_text);
  }
</script>
<script>
  function fileClickHandler(event) {
    var elem = event.target;
    var filename = elem.innerText;
    sessions[open_session] = editor.session;
    editor.setSession(sessions[filename]);
    open_session = filename;
    activeTab = filename;
    editor.resize();
  }
</script>
<script>
  function saveButtonHandler() {
    var newfile = editor.getValue();
    var req = fetch("/exploits/" + open_session, {
      method: "post",
      body: newfile,
    }); // returns a promise

    req.then(
      async function (response) {
        // returns status + response headers
        // but not yet the body,
        // for that call `response[text() || json() || arrayBuffer()]` <-- also promise

        if (response.ok) {
          color = "bg-verde";
        } else {
          color = "bg-rosso";
        }
        document.getElementById("savebutton").classList.remove("bg-viola");
        document.getElementById("savebutton").classList.add(color);
        await new Promise((resolve) => setTimeout(resolve, 900));
        document.getElementById("savebutton").classList.remove(color);
        document.getElementById("savebutton").classList.add("bg-viola");
      },
      function (error) {
        console.error("failed due to network error or cross domain");
      }
    );
  }
</script>
<script>
  function newFileHandler() {}
</script>
<script>
  function deleteHandler(element) {
    let c = confirm(
      "Are you sure you want to delete " +
        element.id +
        "?\nThis action is permanent and cannot be undone"
    );
    if (c == true) {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", "/exploits/delete?filename=" + element.id, true);

      xhr.onload = () => {
        window.location.reload();
      };

      xhr.send();
    }
  }
</script>
{% endblock %} {% block content %}
<div
  class="flex flex-row items-center"
  x-data="{ showModal: false , activeTab }"
  @keydown.window.escape="showModal = false"
>
  <!-- directory view -->
  <div
    class="flex-none flex flex-col justify-between bg-primary items-center rounded-lg shadow mr-4 ml-4 h-[calc(80vh)]"
  >
    <div class="w-full p-4">
      <ul
        id="hierarchy"
        onclick="fileClickHandler(event);"
        class="text-lg bold"
      >
        {% for exploit_filename in filenames %}
        <li
          class="rounded-lg"
          :class="activeTab === '{{ filename }}' ? 'bg-secondary' : 'bg-primary'"
        >
          <div class="flex justify-between">
            <div
              class="flex-none hover:text-viola transition cursor-pointer pl-2"
              @click="activeTab = '{{ exploit_filename }}_tab'"
            ><p>{{ exploit_filename }}</p></div>
            <div
              id="{{ exploit_filename }}"
              class="flex-none relative top-1.5 pr-2"
              onclick="deleteHandler(this);"
            >
              <svg
                class="text-light_gray fill-current w-5 h-5 hover:text-rosso transition cursor-pointer"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="m14.7 9-.3 9m-4.8 0-.3-9m10-3.2 1 .2m-1-.2-1.1 13.9a2.3 2.3 0 0 1-2.3 2H8.1a2.3 2.3 0 0 1-2.3-2l-1-14m14.4 0a48.1 48.1 0 0 0-3.4-.3M3.8 6l1-.2m0 0a48.1 48.1 0 0 1 3.5-.4m7.5 0v-1c0-1.1-1-2-2.1-2.1a52 52 0 0 0-3.4 0c-1.1 0-2 1-2 2.2v.9m7.5 0a48.7 48.7 0 0 0-7.5 0"
                />
              </svg>
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
    <!-- file upload form -->
    <div class="flex-none w-44">
      <div class="m-4">
        <button
          type="button"
          class="self-end p-4 text-white rounded-lg shadow transition bg-viola"
          onclick="newFileHandler();"
        >
          <p class="break-all">Create new file from template</p>
        </button>
      </div>
      <form
        action="/exploits"
        method="POST"
        enctype="multipart/form-data"
        name="fileuploadform"
        class="flex-auto"
      >
        <div
          id="dnd-box"
          class="flex justify-center h-32 m-4 p-4 transition bg-primary rounded-md appearance-none cursor-pointer border-2 border-transparent hover:border-viola border-dashed transition cursor-pointer focus:outline-none"
          ondrop="dropHandler(event);"
          ondragover="dragOverHandler(event);"
          ondragleave="dragLeaveHandler(event);"
        >
          <label>
            <span class="flex items-center space-x-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-secondary-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
              <span class="font-medium text-secondary-600">
                Drop files to Attach, or
                <span class="text-viola hover:underline transition"
                  >browse</span
                >
              </span>
            </span>
            <input
              type="file"
              id="fileinput"
              name="exploit_file"
              class="hidden"
              accept=".py"
              oninput="submitForm();"
              multiple
            />
          </label>
        </div>
      </form>
    </div>
  </div>
  <!---->

  <!-- editor -->
  <div class="flex-auto relative w-[calc(42vw)] z-1">
    <div
      id="editor"
      class="p-4 bg-primary rounded-lg shadow h-[calc(80vh)]"
    ></div>

    <button
      id="savebutton"
      class="absolute bottom-0 right-0 self-end px-4 py-2 text-white rounded-lg shadow mb-2 mr-2 transition bg-viola"
      onclick="saveButtonHandler();"
    >
      Save
    </button>

    <script>
      editor = ace.edit("editor");
      editor.setOptions({
        animatedScroll: true,
        cursorStyle: "slim",
        enableAutoIndent: true,
        fontFamily: "Fira Code",
        fontSize: 13,
        wrapBehavioursEnabled: true,
        theme: "ace/theme/gruvbox", // or twilight or monokai
      });
      sessions = {};
      {% for filename in filenames %}
      sessions["{{ filename }}"] = ace.createEditSession(`{{ files[filename] | safe }}`);
      sessions["{{ filename }}"].setMode("ace/mode/python");
      sessions["{{ filename }}"].setUseWrapMode(true);
      {% endfor %}
      open_session = ace.createEditSession("");
    </script>
  </div>
  <!---->

  <!-- logs -->
  {% for filename in filenames %}
  <div
    x-cloak
    x-show="activeTab === '{{ filename }}_tab'"
    class="flex-auto w-[calc(45vw)] h-[calc(80vh)] mr-4 ml-4 p-2 bg-primary rounded-lg shadow overflow-scroll"
  >
    <pre><code id="{{ filename }}_tab"></code></pre>
  </div>
  {% endfor %}
  <!---->
  {% endblock %}
</div>
